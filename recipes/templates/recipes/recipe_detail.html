{% extends 'base.html' %}
{% load static %}
{% load recipe_filters %}

{% block title %}{{ recipe.name }} - Recipe Book{% endblock %}

{% block extra_css %}
<link rel="stylesheet" href="{% static 'css/recipe-detail.css' %}">
<link rel="stylesheet" href="{% static 'css/premium-recipe.css' %}">
<link rel="stylesheet" href="https://fonts.googleapis.com/css2?family=Playfair+Display:ital,wght@0,400;0,700;1,400&family=Montserrat:wght@300;400;500;600;700&display=swap">
<style>
  /* Premium animation keyframes */
  @keyframes fadeInUp {
    from {
      opacity: 0;
      transform: translateY(30px);
    }
    to {
      opacity: 1;
      transform: translateY(0);
    }
  }
  
  @keyframes subtle-zoom {
    from {
      transform: scale(1);
    }
    to {
      transform: scale(1.03);
    }
  }
  
  /* Animation utility classes */
  .delay-100 { animation-delay: 100ms; }
  .delay-200 { animation-delay: 200ms; }
  .delay-300 { animation-delay: 300ms; }
  .delay-400 { animation-delay: 400ms; }
  .delay-500 { animation-delay: 500ms; }
  
  /* Notification style */
  .notification-container {
    position: fixed;
    top: 20px;
    right: 20px;
    z-index: 9999;
  }
  
  .notification {
    background-color: #C59D5F;
    color: white;
    padding: 15px 25px;
    margin-bottom: 10px;
    border-radius: 8px;
    box-shadow: 0 4px 10px rgba(0,0,0,0.15);
    transform: translateX(120%);
    opacity: 0;
    transition: all 0.3s ease;
  }
  
  .notification.show {
    transform: translateX(0);
    opacity: 1;
  }
  
  /* Ingredient progress styling */
  .ingredient-progress-container {
    background: #f8f9fa;
    border-radius: 30px;
    height: 6px;
    margin: 1rem 0;
    overflow: hidden;
  }
  
  .ingredient-progress-bar {
    height: 100%;
    background: linear-gradient(to right, #C59D5F, #e6be74);
    width: 0%;
    transition: width 0.5s ease;
    border-radius: 30px;
  }
  
  .ingredient-progress-bar.completed {
    background: linear-gradient(to right, #28a745, #5fd675);
  }
  
  .ingredients-header {
    display: flex;
    justify-content: space-between;
    align-items: center;
    margin-bottom: 1rem;
  }
  
  .ingredients-progress-text {
    font-size: 0.9rem;
    color: #6c757d;
  }
  
  /* Enhanced print styles */
  @media print {
    .recipe-header, 
    .key-info-strip,
    .author-section,
    .recipe-quote,
    .recipe-sidebar,
    .action-buttons {
      page-break-inside: avoid;
    }
    
    .ingredient-checkbox,
    .btn-action,
    .sidebar-section a {
      display: none !important;
    }
    
    .ingredient-item {
      break-inside: avoid;
      page-break-inside: avoid;
    }
    
    .ingredient-text {
      margin-left: 0 !important;
    }
    
    .instruction-item {
      break-inside: avoid;
      page-break-inside: avoid;
    }
  }
</style>
{% endblock %}

{% block content %}
<div data-recipe-id="{{ recipe.id }}">
  <!-- Hero Section with Parallax -->
  <div class="recipe-header">
      <div class="parallax-wrapper" id="parallaxBg">
          {% if recipe.images.exists %}
              <img src="{{ recipe.images.first.image.url }}" alt="{{ recipe.name }}" class="recipe-bg-image">
          {% else %}
              <div class="recipe-bg-image bg-dark d-flex align-items-center justify-content-center">
                  <i class="fas fa-utensils fa-5x text-light opacity-50"></i>
              </div>
          {% endif %}
      </div>
      <div class="header-content">
          <div class="recipe-badge">{{ recipe.get_category_display }}</div>
          <h1 class="recipe-title">{{ recipe.name }}</h1>
          {% if recipe.description %}
          <p class="recipe-headline">{{ recipe.description }}</p>
          {% endif %}
      </div>
  </div>

  <!-- Key Information Strip -->
  <div class="key-info-strip">
      <div class="key-info-item">
          <div class="key-info-icon">
              <i class="fas fa-hourglass-start"></i>
          </div>
          <span class="key-info-label">Prep Time</span>
          <span class="key-info-value">{{ recipe.preparation_time|format_time }}</span>
      </div>
      
      <div class="key-info-item">
          <div class="key-info-icon">
              <i class="fas fa-fire"></i>
          </div>
          <span class="key-info-label">Cook Time</span>
          <span class="key-info-value">{{ recipe.cooking_time|format_time }}</span>
      </div>
      
      <div class="key-info-item">
          <div class="key-info-icon">
              <i class="fas fa-clock"></i>
          </div>
          <span class="key-info-label">Total Time</span>
          <span class="key-info-value">{{ recipe.total_time|format_time }}</span>
      </div>
      
      <div class="key-info-item">
          <div class="key-info-icon">
              <i class="fas fa-signal"></i>
          </div>
          <span class="key-info-label">Difficulty</span>
          <span class="key-info-value">{{ recipe.get_difficulty_display }}</span>
      </div>
      
      <div class="key-info-item">
          <div class="key-info-icon">
              <i class="fas fa-users"></i>
          </div>
          <span class="key-info-label">Serves</span>
          <span class="key-info-value">{{ recipe.servings }}</span>
      </div>
  </div>

  <!-- Main Content Wrapper -->
  <div class="content-wrapper">
      <div class="main-content">
          <!-- Main Recipe Content -->
          <div class="recipe-main">
              <!-- Author Info -->
              <div class="author-section scroll-reveal">
                  {% if recipe.user.profile.profile_picture %}
                      <div class="author-image">
                          <img src="{{ recipe.user.profile.profile_picture.url }}" alt="{{ recipe.user.username }}">
                      </div>
                  {% else %}
                      <div class="author-placeholder">
                          <i class="fas fa-user fa-lg"></i>
                      </div>
                  {% endif %}
                  <div class="author-info">
                      <h3>{{ recipe.user.username }}</h3>
                      <div class="author-date">Published on {{ recipe.created_at|date:"F d, Y" }}</div>
                  </div>
              </div>
              
              <!-- Ingredients Section -->
              <div class="content-section scroll-reveal">
                  <div class="section-header">
                      <div class="section-number">01</div>
                      <h2 class="section-title">Ingredients</h2>
                  </div>
                  
                  <div class="ingredients-header">
                      <div class="ingredients-progress-text">
                          Progress: <span class="ingredients-progress">0/{{ recipe.ingredients.count }}</span>
                      </div>
                      <button class="btn btn-sm btn-outline-secondary add-to-shopping-list">
                          <i class="fas fa-shopping-basket mr-1"></i> Add to Shopping List
                      </button>
                  </div>
                  
                  <div class="ingredient-progress-container">
                      <div class="ingredient-progress-bar"></div>
                  </div>
                  
                  <ul class="ingredients-list">
                      {% for ingredient in recipe.ingredients.all %}
                      <li class="ingredient-item scroll-reveal delay-100">
                          <div class="ingredient-checkbox"></div>
                          <div class="ingredient-text">
                              <span class="ingredient-quantity">{{ ingredient.quantity }} {{ ingredient.unit }}</span>
                              {{ ingredient.name }}
                          </div>
                      </li>
                      {% empty %}
                      <li class="ingredient-item scroll-reveal delay-100">
                          <div class="ingredient-checkbox"></div>
                          <div class="ingredient-text">No ingredients listed</div>
                      </li>
                      {% endfor %}
                  </ul>
              </div>
              
              <!-- Recipe Quote -->
              <div class="recipe-quote scroll-reveal">
                  <div class="quote-icon">
                      <i class="fas fa-quote-left"></i>
                  </div>
                  <p class="quote-text">The secret to this recipe is in the precision of the preparation and the quality of the ingredients. Take your time, enjoy the process, and the results will be extraordinary.</p>
              </div>
              
              <!-- Instructions Section -->
              <div class="content-section scroll-reveal">
                  <div class="section-header">
                      <div class="section-number">02</div>
                      <h2 class="section-title">Method</h2>
                  </div>
                  
                  <ul class="instructions-list">
                      {% for step in recipe.preparation_steps.split %}
                      {% if step|length > 5 %}
                      <li class="instruction-item scroll-reveal delay-200">
                          <div class="instruction-text">{{ step }}</div>
                      </li>
                      {% endif %}
                      {% empty %}
                      <li class="instruction-item scroll-reveal delay-200">
                          <div class="instruction-text">No instructions provided</div>
                      </li>
                      {% endfor %}
                  </ul>
              </div>
              
              <!-- Gallery Section (if multiple images) -->
              {% if recipe.images.count > 1 %}
              <div class="content-section scroll-reveal">
                  <div class="section-header">
                      <div class="section-number">03</div>
                      <h2 class="section-title">Gallery</h2>
                  </div>
                  
                  <div class="gallery-grid">
                      {% for image in recipe.images.all %}
                      {% if not forloop.first %}
                      <div class="gallery-item scroll-reveal delay-300">
                          <img src="{{ image.image.url }}" alt="{{ recipe.name }}">
                      </div>
                      {% endif %}
                      {% endfor %}
                  </div>
              </div>
              {% endif %}
              
              <!-- Action Buttons -->
              {% if user == recipe.user %}
              <div class="action-buttons scroll-reveal delay-400">
                  <a href="{% url 'recipe-update' recipe.pk %}" class="btn-action">
                      <i class="fas fa-edit btn-icon"></i> Edit Recipe
                  </a>
                  <a href="{% url 'recipe-delete' recipe.pk %}" class="btn-action">
                      <i class="fas fa-trash btn-icon"></i> Delete Recipe
                  </a>
              </div>
              {% endif %}
          </div>
          
          <!-- Sidebar Content -->
          <div class="recipe-sidebar">
              <h3 class="sidebar-title scroll-reveal">Recipe Notes</h3>
              
              <!-- Tips Section -->
              <div class="sidebar-section scroll-reveal">
                  <h4><i class="fas fa-lightbulb text-warning mr-2"></i> Chef's Tips</h4>
                  <ul class="pl-4 mt-3">
                      <li class="mb-3">For best results, bring all ingredients to room temperature before starting.</li>
                      <li class="mb-3">This dish pairs wonderfully with a light white wine or sparkling water with citrus.</li>
                      <li class="mb-3">Leftovers can be stored in the refrigerator for up to 3 days in an airtight container.</li>
                  </ul>
              </div>
              
              <!-- Nutrition Info -->
              <div class="sidebar-section mt-5 scroll-reveal">
                  <h4><i class="fas fa-heartbeat text-danger mr-2"></i> Nutrition Facts</h4>
                  <table class="nutrition-table mt-3">
                      <tr>
                          <td class="nutrition-label">Calories</td>
                          <td class="nutrition-value">320</td>
                      </tr>
                      <tr>
                          <td class="nutrition-label">Protein</td>
                          <td class="nutrition-value">12g</td>
                      </tr>
                      <tr>
                          <td class="nutrition-label">Carbs</td>
                          <td class="nutrition-value">42g</td>
                      </tr>
                      <tr>
                          <td class="nutrition-label">Fat</td>
                          <td class="nutrition-value">10g</td>
                      </tr>
                      <tr>
                          <td class="nutrition-label">Fiber</td>
                          <td class="nutrition-value">4g</td>
                      </tr>
                  </table>
                  <p class="mt-3 text-muted small">*Nutrition values are approximate and may vary based on exact ingredients used.</p>
              </div>
              
              <!-- Share Buttons -->
              <div class="sidebar-section mt-5 scroll-reveal">
                  <h4><i class="fas fa-share-alt text-info mr-2"></i> Share This Recipe</h4>
                  <div class="d-flex mt-3">
                      <a href="#" class="btn btn-outline-dark mr-2"><i class="fab fa-facebook-f"></i></a>
                      <a href="#" class="btn btn-outline-dark mr-2"><i class="fab fa-twitter"></i></a>
                      <a href="#" class="btn btn-outline-dark mr-2"><i class="fab fa-pinterest"></i></a>
                      <a href="#" class="btn btn-outline-dark"><i class="far fa-envelope"></i></a>
                  </div>
              </div>
              
              <!-- Print Button -->
              <div class="mt-5 scroll-reveal">
                  <button class="btn btn-dark btn-block print-recipe-button">
                      <i class="fas fa-print mr-2"></i> Print Recipe
                  </button>
              </div>
          </div>
      </div>
  </div>
</div>

<script>
    document.addEventListener('DOMContentLoaded', function() {
        // Parallax effect for header
        window.addEventListener('scroll', function() {
            const parallaxBg = document.getElementById('parallaxBg');
            if (parallaxBg) {
                const scrollPosition = window.pageYOffset;
                parallaxBg.style.transform = 'translateY(' + scrollPosition * 0.4 + 'px)';
            }
        });
        
        // Scroll reveal animations
        const revealElements = document.querySelectorAll('.scroll-reveal');
        
        const revealOnScroll = function(entries, observer) {
            entries.forEach(entry => {
                if (entry.isIntersecting) {
                    entry.target.classList.add('revealed');
                    observer.unobserve(entry.target);
                }
            });
        };
        
        const observer = new IntersectionObserver(revealOnScroll, {
            threshold: 0.1,
            rootMargin: '0px 0px -50px 0px'
        });
        
        revealElements.forEach(element => {
            observer.observe(element);
        });
        
        // Initialize visible elements in viewport
        setTimeout(() => {
            revealElements.forEach(el => {
                const rect = el.getBoundingClientRect();
                if (rect.top < window.innerHeight) {
                    el.classList.add('revealed');
                }
            });
        }, 100);
        
        // Ingredient checkbox interaction
        const checkboxes = document.querySelectorAll('.ingredient-checkbox');
        checkboxes.forEach(checkbox => {
            checkbox.addEventListener('click', function() {
                this.classList.toggle('checked');
                const parentItem = this.closest('.ingredient-item');
                parentItem.querySelector('.ingredient-text').style.textDecoration = 
                    this.classList.contains('checked') ? 'line-through' : 'none';
                parentItem.querySelector('.ingredient-text').style.opacity = 
                    this.classList.contains('checked') ? '0.6' : '1';
                
                // Add animation class
                if (this.classList.contains('checked')) {
                    parentItem.classList.add('ingredient-checked');
                } else {
                    parentItem.classList.remove('ingredient-checked');
                }
                
                // Store checked state in localStorage
                const recipeId = {{ recipe.id }};
                const itemIndex = Array.from(checkboxes).indexOf(this);
                const storageKey = `recipe_${recipeId}_ingredients`;
                
                let checkedItems = JSON.parse(localStorage.getItem(storageKey) || '{}');
                checkedItems[itemIndex] = this.classList.contains('checked');
                localStorage.setItem(storageKey, JSON.stringify(checkedItems));
                
                // Update progress counter and bar
                updateIngredientProgress();
            });
        });
        
        // Restore ingredient checked state from localStorage
        const recipeId = {{ recipe.id }};
        const storageKey = `recipe_${recipeId}_ingredients`;
        const checkedItems = JSON.parse(localStorage.getItem(storageKey) || '{}');
        
        Object.entries(checkedItems).forEach(([index, isChecked]) => {
            if (isChecked && checkboxes[index]) {
                checkboxes[index].classList.add('checked');
                const parentItem = checkboxes[index].closest('.ingredient-item');
                parentItem.querySelector('.ingredient-text').style.textDecoration = 'line-through';
                parentItem.querySelector('.ingredient-text').style.opacity = '0.6';
                parentItem.classList.add('ingredient-checked');
            }
        });
        
        // Update progress counter and bar
        function updateIngredientProgress() {
            const progressElement = document.querySelector('.ingredients-progress');
            const checkedCount = document.querySelectorAll('.ingredient-checkbox.checked').length;
            const total = checkboxes.length;
            
            // Update text
            if (progressElement) {
                progressElement.textContent = `${checkedCount}/${total}`;
            }
            
            // Update progress bar
            const progressBar = document.querySelector('.ingredient-progress-bar');
            if (progressBar) {
                const percentage = total > 0 ? (checkedCount / total) * 100 : 0;
                progressBar.style.width = `${percentage}%`;
                
                // Add completion class if all checked
                if (checkedCount === total && total > 0) {
                    progressBar.classList.add('completed');
                    showNotification('All ingredients checked! âœ¨');
                } else {
                    progressBar.classList.remove('completed');
                }
            }
        }
        
        // Initialize progress indicator
        updateIngredientProgress();
        
        // Print functionality
        const printButton = document.querySelector('.print-recipe-button');
        if (printButton) {
            printButton.addEventListener('click', function(e) {
                e.preventDefault();
                window.print();
            });
        }
        
        // Add to shopping list functionality
        const addToShoppingListButton = document.querySelector('.add-to-shopping-list');
        if (addToShoppingListButton) {
            addToShoppingListButton.addEventListener('click', function(e) {
                e.preventDefault();
                
                // Get recipe name
                const recipeName = document.querySelector('.recipe-title').textContent.trim();
                
                // Get all ingredients
                const uncheckedIngredients = [];
                document.querySelectorAll('.ingredient-item').forEach((item) => {
                    const checkbox = item.querySelector('.ingredient-checkbox');
                    if (!checkbox.classList.contains('checked')) {
                        const textElement = item.querySelector('.ingredient-text');
                        if (textElement) {
                            uncheckedIngredients.push(textElement.textContent.trim());
                        }
                    }
                });
                
                // Save to shopping list in localStorage
                let shoppingList = JSON.parse(localStorage.getItem('shopping_list') || '{}');
                shoppingList[recipeName] = uncheckedIngredients;
                localStorage.setItem('shopping_list', JSON.stringify(shoppingList));
                
                // Show notification
                showNotification('Added to shopping list! ðŸ›’');
            });
        }
        
        // Show notification function
        function showNotification(message) {
            // Create container if it doesn't exist
            let container = document.querySelector('.notification-container');
            if (!container) {
                container = document.createElement('div');
                container.className = 'notification-container';
                document.body.appendChild(container);
            }
            
            // Create notification
            const notification = document.createElement('div');
            notification.className = 'notification';
            notification.textContent = message;
            
            // Add to container
            container.appendChild(notification);
            
            // Trigger animation
            setTimeout(() => {
                notification.classList.add('show');
            }, 10);
            
            // Remove after delay
            setTimeout(() => {
                notification.classList.remove('show');
                setTimeout(() => {
                    notification.remove();
                }, 300);
            }, 3000);
        }
    });
</script>
{% endblock %} 